<div class="analysis-container">
  <!-- Header Section -->
  <div class="analysis-header">
    <div class="header-content">
      <div class="header-left">
        <h1 class="analysis-title">ğŸ“Š Expense Analysis</h1>
        <p class="analysis-subtitle">Detailed category-wise spending analysis across months</p>
      </div>
      <div class="header-actions">
        <button class="action-btn primary" (click)="exportAnalysis()">
          <span class="action-icon">ğŸ“¥</span>
          <span class="action-text">Export Analysis</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Loading Spinner -->
  <app-loading 
    *ngIf="isLoading" 
    message="Loading expense analysis..." 
    type="card">
  </app-loading>

  <!-- Enhanced Filters Section -->
  <div class="filters-section" *ngIf="!isLoading">
    <div class="filters-header">
      <h3>ğŸ” Smart Analysis Filters</h3>
      <p>Advanced filtering and search capabilities for detailed expense analysis</p>
      <div class="filter-actions">
        <button class="btn-clear-all" (click)="clearAllFilters()" *ngIf="selectedDatePreset !== 'thisMonth'">
          <span class="clear-icon">ğŸ—‘ï¸</span>
          Clear All Filters
        </button>
      </div>
    </div>
    
    <!-- Quick Date Presets -->
    <div class="date-presets-section">
      <h4>ğŸ“… Quick Date Ranges</h4>
      <div class="preset-buttons">
        <button class="preset-btn" 
                [class.active]="selectedDatePreset === 'thisMonth'"
                (click)="applyDatePreset('thisMonth')">
          This Month
        </button>
        <button class="preset-btn" 
                [class.active]="selectedDatePreset === 'thisQuarter'"
                (click)="applyDatePreset('thisQuarter')">
          This Quarter
        </button>
        <button class="preset-btn" 
                [class.active]="selectedDatePreset === 'thisYear'"
                (click)="applyDatePreset('thisYear')">
          This Year
        </button>
        <button class="preset-btn" 
                [class.active]="selectedDatePreset === 'lastYear'"
                (click)="applyDatePreset('lastYear')">
          Last Year
        </button>
        <button class="preset-btn" 
                [class.active]="selectedDatePreset === 'all'"
                (click)="applyDatePreset('all')">
          All Time
        </button>
      </div>
    </div>
    
    <!-- Smart Search -->
    <div class="search-section">
      <h4>ğŸ” Smart Search</h4>
      <div class="search-container">
        <input 
          type="text" 
          class="search-input" 
          placeholder="Search by description, amount, notes, or location..."
          [(ngModel)]="searchQuery"
          (input)="onFilterChange()">
        <span class="search-icon" *ngIf="!searchQuery">ğŸ”</span>
        <span class="clear-icon" 
              *ngIf="searchQuery" 
              (click)="clearSearch()"
              title="Clear search">
          âœ•
        </span>
      </div>
    </div>
    
    <div class="filters-grid">
      <!-- Date Range Filters -->
      <div class="filter-group">
        <label class="filter-label">From Date</label>
        <input 
          type="date" 
          class="filter-date-input" 
          [(ngModel)]="selectedStartDate"
          (change)="onFilterChange()"
          [max]="getMaxDate()">
      </div>
      
      <div class="filter-group">
        <label class="filter-label">To Date</label>
        <input 
          type="date" 
          class="filter-date-input" 
          [(ngModel)]="selectedEndDate"
          (change)="onFilterChange()"
          [max]="getMaxDate()"
          [min]="selectedStartDate">
      </div>
      
      <!-- Amount Range Filters -->
      <div class="filter-group">
        <label class="filter-label">Min Amount (â‚¹)</label>
        <input 
          type="number" 
          class="filter-amount-input" 
          [(ngModel)]="minAmount"
          (input)="onFilterChange()"
          placeholder="0"
          min="0">
      </div>
      
      <div class="filter-group">
        <label class="filter-label">Max Amount (â‚¹)</label>
        <input 
          type="number" 
          class="filter-amount-input" 
          [(ngModel)]="maxAmount"
          (input)="onFilterChange()"
          placeholder="No limit"
          min="0">
      </div>
      
      <div class="filter-group">
        <label class="filter-label">
          <span class="label-icon">ğŸ·ï¸</span>
          Categories
        </label>
        <div class="multiselect-container">
          <div class="multiselect-dropdown" 
               [class.open]="isCategoryDropdownOpen" 
               (click)="toggleCategoryDropdown($event)"
               role="combobox"
               [attr.aria-expanded]="isCategoryDropdownOpen"
               [attr.aria-haspopup]="true"
               tabindex="0"
               (keydown.enter)="toggleCategoryDropdown($event)"
               (keydown.escape)="isCategoryDropdownOpen = false; onFilterChange()">
            <div class="multiselect-display">
              <div class="selection-content">
                <span *ngIf="selectedCategories.length === 0" class="placeholder">
                  <span class="placeholder-icon">ğŸ“‹</span>
                  All Categories
                </span>
                <span *ngIf="selectedCategories.length === 1" class="single-selection">
                  <span class="selection-icon">{{ getCategoryIcon(selectedCategories[0]) }}</span>
                  {{ getCategoryName(selectedCategories[0]) }}
                </span>
                <span *ngIf="selectedCategories.length > 1" class="multiple-selection">
                  <span class="selection-badge">{{ selectedCategories.length }}</span>
                  categories selected
                </span>
              </div>
              <span class="dropdown-arrow" [class.rotated]="isCategoryDropdownOpen">â–¼</span>
            </div>
            <div class="multiselect-options" 
                 *ngIf="isCategoryDropdownOpen"
                 role="listbox"
                 [attr.aria-label]="'Category selection options'">
              
              <!-- Header Section -->
              <div class="options-header">
                <span class="header-text">Select Categories</span>
                <span class="header-count">{{ selectedCategories.length }} of {{ availableCategories.length }}</span>
              </div>
              
              <!-- Scrollable Content Area -->
              <div class="options-content">
                <!-- No categories message -->
                <div class="no-categories-message" *ngIf="availableCategories.length === 0">
                  <div class="message-icon">ğŸ“­</div>
                  <div class="message-text">
                    <div class="message-title">No Categories Found</div>
                    <div class="message-subtitle">No categories available</div>
                  </div>
                </div>
                
                <!-- Category options -->
                <div class="option-item" 
                     *ngFor="let category of availableCategories; trackBy: trackByCategoryId"
                     role="option"
                     [attr.aria-selected]="isCategorySelected(category.id)"
                     (click)="$event.stopPropagation()">
                  <label class="checkbox-label" (click)="$event.stopPropagation()">
                    <input 
                      type="checkbox" 
                      [value]="category.id"
                      [checked]="isCategorySelected(category.id)"
                      (change)="toggleCategorySelection(category.id, $event)"
                      (click)="$event.stopPropagation()"
                      [attr.aria-label]="'Select ' + category.name">
                    <span class="checkbox-custom"></span>
                    <span class="option-text">
                      <span class="category-icon">{{ category.icon }}</span>
                      <span class="category-name">{{ category.name }}</span>
                      <span class="category-count" *ngIf="getCategoryExpenseCount(category.id) > 0">
                        ({{ getCategoryExpenseCount(category.id) }})
                      </span>
                    </span>
                  </label>
                </div>
              </div>
              
              <!-- Fixed Action Buttons -->
              <div class="multiselect-actions" (click)="$event.stopPropagation()">
                <button class="action-btn select-all" 
                        (click)="selectAllCategories(); $event.stopPropagation()"
                        [disabled]="selectedCategories.length === availableCategories.length">
                  <span class="btn-icon">âœ…</span>
                  Select All
                </button>
                <button class="action-btn clear-all" 
                        (click)="clearAllCategories(); $event.stopPropagation()"
                        [disabled]="selectedCategories.length === 0">
                  <span class="btn-icon">ğŸ—‘ï¸</span>
                  Clear All
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="filter-summary">
      <div class="summary-info">
        <span class="summary-label">Analysis Period:</span>
        <span class="summary-value">{{ getFilterLabel() }}</span>
      </div>
    </div>
  </div>

  <!-- Show Charts Button -->
  <div class="show-charts-section" *ngIf="!isLoading && !showCharts">
    <div class="charts-header">
      <div class="charts-title">
        <h3>Interactive Data Visualization</h3>
        <p>Visual insights into your spending patterns and trends</p>
      </div>
      <div class="charts-controls">
        <button class="btn-charts" (click)="toggleCharts($event)">
          <span class="chart-icon">ğŸ“Š</span>
          Show Charts
        </button>
      </div>
    </div>
  </div>

  <!-- Interactive Charts Section -->
  <div class="charts-section" *ngIf="!isLoading && showCharts">
    <div class="charts-header">
      <div class="charts-title">
        <h3>Interactive Data Visualization</h3>
        <p>Visual insights into your spending patterns and trends</p>
      </div>
      <div class="charts-controls">
        <button class="btn-charts" (click)="toggleCharts($event)" [class.active]="showCharts">
          <span class="chart-icon">ğŸ“Š</span>
          Hide Charts
        </button>
      </div>
    </div>
    
    
    <div class="charts-grid">
      <!-- Trend Line Chart -->
      <div class="chart-card" *ngIf="trendData">
        <div class="chart-header">
          <h4>ğŸ“ˆ Spending Trends</h4>
          <p>Monthly spending patterns over time</p>
        </div>
        <div class="chart-container">
          <canvas baseChart
                  [data]="trendData"
                  [options]="getTrendOptions()"
                  type="line">
          </canvas>
        </div>
      </div>

      <!-- Pie Chart -->
      <div class="chart-card" *ngIf="pieData">
        <div class="chart-header">
          <h4>ğŸ¥§ Category Breakdown</h4>
          <p>Spending distribution by category</p>
        </div>
        <div class="chart-container">
          <canvas baseChart
                  [data]="pieData"
                  [options]="getPieOptions()"
                  type="pie">
          </canvas>
        </div>
      </div>

      <!-- Bar Chart -->
      <div class="chart-card" *ngIf="barData">
        <div class="chart-header">
          <h4>ğŸ“Š Monthly Comparison</h4>
          <p>Monthly spending comparison</p>
        </div>
        <div class="chart-container">
          <canvas baseChart
                  [data]="barData"
                  [options]="getBarOptions()"
                  type="bar">
          </canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Orphaned Expenses Warning -->
  <div class="orphaned-warning" *ngIf="!isLoading && hasOrphanedExpenses()">
    <div class="warning-content">
      <div class="warning-icon">âš ï¸</div>
      <div class="warning-text">
        <h3>Orphaned Expenses Detected</h3>
        <p>You have {{ getOrphanedExpensesCount() }} expenses (â‚¹{{ getOrphanedExpensesAmount() | number }}) with missing categories. 
           These expenses reference category IDs that no longer exist in your categories list.</p>
        <div class="warning-actions">
          <button class="btn btn-outline" routerLink="/mapper">
            <span class="btn-icon">ğŸ”§</span>
            Auto-Fix with Mapper
          </button>
          <button class="btn btn-outline" routerLink="/expenses">
            <span class="btn-icon">âœï¸</span>
            Fix Manually
          </button>
          <button class="btn btn-outline" routerLink="/categories">
            <span class="btn-icon">ğŸ·ï¸</span>
            Manage Categories
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Summary Cards -->
  <div class="summary-section" *ngIf="!isLoading">
    <div class="summary-grid">
      <div class="summary-card">
        <div class="card-header">
          <span class="card-icon">ğŸ’°</span>
          <span class="card-title">Total Expenses</span>
        </div>
        <div class="card-content">
          <div class="card-value">â‚¹{{ totalExpenses | number }}</div>
          <div class="card-subtitle">{{ totalExpenseCount }} transactions</div>
        </div>
      </div>
      
      <div class="summary-card">
        <div class="card-header">
          <span class="card-icon">ğŸ“Š</span>
          <span class="card-title">Average per Expense</span>
        </div>
        <div class="card-content">
          <div class="card-value">â‚¹{{ averageExpenseAmount | number:'1.0-0' }}</div>
          <div class="card-subtitle">Per transaction</div>
        </div>
      </div>
      
      <div class="summary-card">
        <div class="card-header">
          <span class="card-icon">ğŸ·ï¸</span>
          <span class="card-title">Categories</span>
        </div>
        <div class="card-content">
          <div class="card-value">{{ categoryAnalysis.length }}</div>
          <div class="card-subtitle">Active categories</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Category Analysis Section -->
  <div class="analysis-section" *ngIf="!isLoading">
    <div class="section-header">
      <div class="section-title-group">
        <div>
          <h2>ğŸ“ˆ Category-wise Analysis</h2>
          <p>Detailed breakdown of spending by category with monthly trends</p>
        </div>
        <div class="sort-controls" *ngIf="categoryAnalysis.length > 0">
          <div class="sort-group">
            <label class="sort-label">
              <span class="sort-icon">ğŸ”„</span>
              Sort by:
            </label>
            <select 
              class="sort-select" 
              [(ngModel)]="sortBy"
              (change)="onSortChange()">
              <option value="percentage">Percentage</option>
              <option value="transactionCount">Transaction Count</option>
              <option value="average">Average Amount</option>
              <option value="name">Category Name</option>
            </select>
            <button 
              class="sort-order-btn" 
              (click)="toggleSortOrder()"
              [title]="sortOrder === 'asc' ? 'Ascending - Click for Descending' : 'Descending - Click for Ascending'">
              <span class="sort-arrow" [class.asc]="sortOrder === 'asc'">â–¼</span>
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- Normal Category Analysis -->
    <div class="category-analysis" *ngIf="categoryAnalysis.length > 0 && !comparisonMode">
      <div class="category-item" 
           *ngFor="let analysis of categoryAnalysis; let i = index"
           (click)="showCategoryExpenses(analysis)"
           [class.clickable]="!comparisonMode">
        <div class="category-header">
          <div class="category-info">
            <div class="category-icon" [style.background-color]="analysis.category.color || '#999'">
              {{ analysis.category.icon || 'ğŸ“Œ' }}
            </div>
            <div class="category-details">
              <h3 class="category-name">{{ analysis.category.name }}</h3>
              <div class="category-rank">#{{ i + 1 }}</div>
            </div>
          </div>
          
          <div class="category-stats">
            <div class="stat-item">
              <span class="stat-label">Total Amount</span>
              <span class="stat-value">â‚¹{{ analysis.totalAmount | number }}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Percentage</span>
              <span class="stat-value">{{ analysis.percentage | number:'1.1-1' }}%</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Transactions</span>
              <span class="stat-value">{{ analysis.expenseCount }}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Average</span>
              <span class="stat-value">â‚¹{{ analysis.averageAmount | number:'1.0-0' }}</span>
            </div>
          </div>
        </div>
        
        <!-- Category Progress Bar -->
        <div class="category-progress">
          <div class="progress-bar">
            <div class="progress-fill" 
                 [style.width.%]="analysis.percentage"
                 [style.background-color]="analysis.category.color || '#999'">
            </div>
          </div>
          <div class="progress-label">{{ analysis.percentage | number:'1.1-1' }}%</div>
        </div>
        
        <!-- Monthly Breakdown -->
        <div class="monthly-breakdown" *ngIf="analysis.monthlyBreakdown.length > 0">
          <h4>Monthly Breakdown</h4>
          <div class="monthly-chart">
            <div class="month-item clickable-month" 
                 *ngFor="let month of analysis.monthlyBreakdown"
                 (click)="showMonthlyExpenses(analysis, month); $event.stopPropagation()"
                 title="Click to view expenses for {{ month.month }} {{ month.year }}">
              <div class="month-header">
                <span class="month-name">{{ month.month }} {{ month.year }}</span>
                <span class="month-amount">â‚¹{{ month.amount | number }}</span>
              </div>
              <div class="month-bar">
                <div class="bar-fill" 
                     [style.width.%]="(month.amount / analysis.totalAmount) * 100"
                     [style.background-color]="analysis.category.color || '#999'">
                </div>
              </div>
              <div class="month-details">
                <span class="month-count">{{ month.expenseCount }} transactions</span>
                <span class="month-percentage">{{ ((month.amount / analysis.totalAmount) * 100) | number:'1.1-1' }}%</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="empty-state" *ngIf="categoryAnalysis.length === 0">
      <div class="empty-icon">ğŸ“Š</div>
      <h3>No Data Found</h3>
      <p>No expenses found for the selected filters. Try adjusting your date range or category selection.</p>
    </div>
  </div>

  <!-- Top Categories Summary -->
  <div class="top-categories-section" *ngIf="!isLoading && categoryAnalysis.length > 0">
    <div class="section-header">
      <h2>ğŸ† Top Categories</h2>
      <p>Your highest spending categories</p>
    </div>
    
    <div class="top-categories-grid">
      <div class="top-category-card" *ngFor="let category of topCategoriesWithTrends; let i = index">
        <div class="rank-badge">{{ i + 1 }}</div>
        <div class="category-icon" [style.background-color]="category.category.color || '#999'">
          {{ category.category.icon || 'ğŸ“Œ' }}
        </div>
        <div class="category-info">
          <h4 class="category-name">{{ category.category.name }}</h4>
          <div class="category-amount">â‚¹{{ category.totalAmount | number }}</div>
          <div class="category-percentage">{{ category.percentage | number:'1.1-1' }}%</div>
        </div>
        <div class="category-trend" *ngIf="category.trend.trend !== 'stable'">
          <span class="trend-icon" [class]="'trend-' + category.trend.trend">
            {{ category.trend.trend === 'up' ? 'ğŸ“ˆ' : 
               category.trend.trend === 'down' ? 'ğŸ“‰' : 'ğŸ†•' }}
          </span>
          <span class="trend-text">{{ category.trend.trend }}</span>
        </div>
      </div>
    </div>
  </div>


</div>
