<div class="container-fluid px-4 py-3">
  <!-- Page Header -->
  <div class="page-header mb-4">
    <div class="d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center">
        <div class="header-icon me-3">
          <span class="fs-1">ğŸ’¸</span>
        </div>
        <div>
          <h1 class="page-title mb-1">
            {{ filterCategory && getCategoryName(filterCategory) ? getCategoryName(filterCategory) + ' Expenses' : 'Expenses' }}
          </h1>
          <p class="mb-0">
            {{ filterCategory && getCategoryName(filterCategory) ? 'Viewing expenses for ' + getCategoryName(filterCategory) : 'Track and manage your daily expenses' }}
          </p>
        </div>
      </div>
      <div class="header-actions" *ngIf="!isLoading && getFilteredExpenses().length > 0">
        <button 
          class="btn-header-action" 
          (click)="exportToPDF()" 
          title="Download PDF"
          [disabled]="isGeneratingPDF || isPrinting">
          <span class="btn-icon">ğŸ“„</span>
          <span class="btn-text">PDF</span>
        </button>
        <button 
          class="btn-header-action" 
          (click)="printExpenses()" 
          title="Print Expenses"
          [disabled]="isGeneratingPDF || isPrinting">
          <span class="btn-icon">ğŸ–¨ï¸</span>
          <span class="btn-text">Print</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Loading Spinner -->
  <app-loading 
    *ngIf="isLoading" 
    message="Loading expenses..." 
    type="card">
  </app-loading>

  <!-- PDF Generation Loader -->
  <app-loading 
    *ngIf="isGeneratingPDF || isPrinting" 
    [message]="isGeneratingPDF ? 'Generating PDF...' : 'Preparing print...'"
    [fullscreen]="true">
  </app-loading>
  
  <!-- Global Search Bar -->
  <div class="search-card mb-4" *ngIf="!isLoading">
    <div class="card-body-modern">
      <div class="search-container">
        <div class="search-input-group">
          <span class="search-icon">ğŸ”</span>
          <div class="search-input-wrapper">
            <input 
              type="text" 
              class="search-input" 
              placeholder=""
              [(ngModel)]="globalSearch"
              (input)="onSearchChange()"
              (focus)="onSearchFocus()"
              (blur)="onSearchBlur()"
              name="globalSearch">
            <div class="search-placeholder-marquee" *ngIf="!globalSearch && !isSearchFocused">
              <span class="marquee-text">Search expenses by description, notes, location, category, amount, tags...</span>
            </div>
          </div>
          <button 
            *ngIf="globalSearch" 
            class="clear-search-btn" 
            (click)="globalSearch = ''; onSearchChange()" 
            title="Clear search">
            âœ•
          </button>
        </div>
        <div class="search-results-info" *ngIf="globalSearch">
          <span class="search-count">
            {{ getFilteredExpenses().length }} result{{ getFilteredExpenses().length !== 1 ? 's' : '' }} found
          </span>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Add Expense Form -->
  <div class="add-expense-card mb-4" *ngIf="!isLoading">
    <div class="card-header-modern">
      <div class="d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center">
          <span class="header-icon-small me-2">{{ isEditMode ? 'âœï¸' : 'â•' }}</span>
          <h5 class="mb-0">{{ isEditMode ? 'Edit Expense' : 'Add New Expense' }}</h5>
        </div>
        <button class="collapse-toggle-btn" type="button" (click)="toggleAddExpenseSection()">
          <span class="collapse-icon" [class.rotated]="!isAddExpenseExpanded">â–¼</span>
        </button>
      </div>
    </div>
    <div class="card-body-modern collapsible-content" [class.collapsed]="!isAddExpenseExpanded">
      <form (ngSubmit)="addExpense()" #expenseForm="ngForm">
        <div class="form-row">
          <div class="form-group">
            <label for="expenseAmount" class="form-label-modern">Amount</label>
            <div class="input-group-modern">
              <span class="input-group-text-modern">â‚¹</span>
              <input 
                type="text" 
                class="form-control-modern" 
                id="expenseAmount"
                placeholder="0.00"
                [(ngModel)]="amountInput" 
                name="amount" 
                (input)="onAmountInput($event)"
                (keypress)="onAmountKeypress($event)"
                required>
            </div>
          </div>
          <div class="form-group">
            <label for="expenseDate" class="form-label-modern">Date</label>
            <input 
              type="date" 
              class="form-control-modern" 
              id="expenseDate"
              [(ngModel)]="newExpense.date" 
              name="date" 
              [max]="getMaxDate()"
              required>
          </div>
          <div class="form-group">
            <label for="expenseCategory" class="form-label-modern">Category</label>
            <div class="category-select-container">
              <select 
                class="form-select" 
                [class.invalid-category]="newExpense.categoryId && !validateCategoryExists(newExpense.categoryId).exists"
                id="expenseCategory"
                [(ngModel)]="newExpense.categoryId" 
                name="categoryId" 
                (change)="onCategoryChange()"
                required>
                <option value="" [selected]="!newExpense.categoryId">ğŸ·ï¸ Select a category</option>
                <option *ngFor="let cat of categories" [value]="cat.id">
                  {{cat.icon}} {{cat.name}}
                </option>
              </select>
              <button 
                *ngIf="newExpense.categoryId" 
                type="button"
                class="clear-category-btn"
                (click)="clearCategory()"
                title="Clear selection">
                âœ•
              </button>
            </div>
            <!-- Category validation message -->
            <div *ngIf="newExpense.categoryId && !validateCategoryExists(newExpense.categoryId).exists" class="category-error-message">
              <span class="error-icon">âš ï¸</span>
              <span *ngIf="validateCategoryExists(newExpense.categoryId).wasDeleted">
                This category was deleted. Please select a different category.
              </span>
              <span *ngIf="!validateCategoryExists(newExpense.categoryId).wasDeleted">
                Invalid category selected. Please choose a valid category.
              </span>
            </div>
            <!-- Category suggestions -->
            <div *ngIf="showSuggestions && categorySuggestions.length > 0 && !newExpense.categoryId" class="category-suggestions">
              <div class="suggestions-header">ğŸ’¡ Suggested categories:</div>
              <div class="suggestions-list">
                <button 
                  type="button"
                  class="suggestion-item"
                  *ngFor="let suggestion of categorySuggestions"
                  (click)="selectSuggestedCategory(suggestion)">
                  <span class="suggestion-icon">{{suggestion.icon}}</span>
                  <span class="suggestion-name">{{suggestion.name}}</span>
                </button>
              </div>
            </div>
          </div>
          <div class="form-group">
            <label for="expenseDescription" class="form-label-modern">Description</label>
            <input 
              type="text" 
              class="form-control-modern" 
              id="expenseDescription"
              placeholder="e.g., Lunch at restaurant, Uber ride, Movie ticket, Groceries, etc."
              [(ngModel)]="newExpense.description" 
              name="description"
              (input)="onDescriptionChange($event)">
          </div>
          <div class="form-group button-group">
            <label class="form-label-modern">&nbsp;</label>
            <div class="d-flex gap-2">
              <button type="submit" class="btn-add-expense" [disabled]="!isFormValid() || isSaving">
                <span class="btn-icon" *ngIf="!isSaving">{{ isEditMode ? 'ğŸ’¾' : 'â•' }}</span>
                <app-loading 
                  *ngIf="isSaving" 
                  message="{{ isEditMode ? 'Saving...' : 'Adding...' }}" 
                  type="button" 
                  size="small">
                </app-loading>
                <span class="btn-text" *ngIf="!isSaving">{{ isEditMode ? 'Save Changes' : 'Add Expense' }}</span>
              </button>
              <button 
                *ngIf="isEditMode" 
                type="button" 
                class="btn-cancel"
                (click)="cancelEdit()">
                <span class="btn-icon">âŒ</span>
                <span class="btn-text">Cancel</span>
              </button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-card mb-4">
    <div class="card-header-modern">
      <div class="d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center">
          <span class="header-icon-small me-2">ğŸ”</span>
          <h5 class="mb-0">Filters</h5>
        </div>
        <button class="collapse-toggle-btn" type="button" (click)="toggleFiltersSection()">
          <span class="collapse-icon" [class.rotated]="!isFiltersExpanded">â–¼</span>
        </button>
      </div>
      <!-- Active Filter Indicators -->
      <div class="active-filters mt-2" *ngIf="isFiltersExpanded">
        <!-- Active Category Filter Indicator -->
        <div *ngIf="filterCategory && getCategoryName(filterCategory)" class="active-filter-indicator">
          <span class="filter-badge">
            {{getCategoryIcon(filterCategory)}} {{getCategoryName(filterCategory)}}
            <button class="clear-filter-btn" (click)="clearCategoryFilter()" title="Clear category filter">
              âœ•
            </button>
          </span>
        </div>
        
        <!-- Manual Date Filter Indicator -->
        <div *ngIf="filterDateFrom || filterDateTo" class="active-filter-indicator">
          <span class="filter-badge manual-filter">
            ğŸ“… Manual Date Filter
            <button class="clear-filter-btn" (click)="filterDateFrom = ''; filterDateTo = ''; resetPagination()" title="Clear date filter">
              âœ•
            </button>
          </span>
        </div>
        
        <!-- Dashboard Filter Indicator -->
        <div *ngIf="dashboardPeriod && dashboardPeriod !== 'all' && !filterDateFrom && !filterDateTo" class="active-filter-indicator">
          <span class="filter-badge dashboard-filter">
            ğŸ  Dashboard Filter: {{ getDashboardFilterLabel() }}
            <button class="clear-filter-btn" (click)="clearDashboardFilterState(); resetPagination()" title="Clear dashboard filter">
              âœ•
            </button>
          </span>
        </div>
      </div>
    </div>
    <div class="card-body-modern collapsible-content" [class.collapsed]="!isFiltersExpanded">
      <div class="filters-row">
        <div class="filter-group">
          <label for="filterCategory" class="form-label-modern">Category</label>
          <select class="form-select" id="filterCategory" [(ngModel)]="filterCategory" (change)="onCategoryFilterChange()">
            <option value="">ğŸ·ï¸ All Categories</option>
            <option *ngFor="let cat of categories" [value]="cat.id">{{cat.icon}} {{cat.name}}</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="filterDateFrom" class="form-label-modern">From Date</label>
          <input type="date" class="form-control-modern" id="filterDateFrom" [(ngModel)]="filterDateFrom" [max]="getMaxDate()" (change)="onFromDateChange()">
        </div>
        <div class="filter-group">
          <label for="filterDateTo" class="form-label-modern">To Date</label>
          <input type="date" class="form-control-modern" id="filterDateTo" [(ngModel)]="filterDateTo" [max]="getMaxDate()" [min]="filterDateFrom" (change)="onToDateChange()">
        </div>
        <div class="filter-group">
          <label for="filterAmount" class="form-label-modern">Min Amount</label>
          <input type="text" class="form-control-modern" id="filterAmount" [(ngModel)]="filterAmount" placeholder="0" (input)="onFilterAmountInput($event)" (keypress)="onFilterAmountKeypress($event)">
        </div>
        <div class="filter-group">
          <label for="sortBy" class="form-label-modern">Sort By</label>
          <select class="form-select" id="sortBy" [(ngModel)]="sortBy" (change)="onSortChange()">
            <option value="date">ğŸ“… Date</option>
            <option value="amount">ğŸ’° Amount</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="sortOrder" class="form-label-modern">Order</label>
          <select class="form-select" id="sortOrder" [(ngModel)]="sortOrder" (change)="onSortChange()">
            <option value="desc">â¬‡ï¸ Descending</option>
            <option value="asc">â¬†ï¸ Ascending</option>
          </select>
        </div>
        <div class="filter-group button-group">
          <label class="form-label-modern">&nbsp;</label>
          <button type="button" class="btn-clear-filters" (click)="clearFilters()">
            <span class="btn-icon">ğŸ”„</span>
            <span class="btn-text">Clear Filters</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Expenses List -->
  <div class="expenses-list-card" *ngIf="!isLoading">
    <div class="card-header-modern">
      <div class="d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
          <span class="header-icon-small me-2">ğŸ“‹</span>
          <h5 class="mb-0">All Expenses</h5>
        </div>
        <div class="d-flex align-items-center gap-3">
          <div class="expenses-summary" *ngIf="isExpensesListExpanded">
            <div class="total-amount">
              {{bulkSelectionMode && selectedExpenseIds.size > 0 ? (getSelectedExpensesTotal() | currency:'INR') : (getTotalAmount() | currency:'INR')}}
            </div>
            <div class="expenses-count">
              {{bulkSelectionMode && selectedExpenseIds.size > 0 ? (selectedExpenseIds.size + (selectedExpenseIds.size === 1 ? ' expense' : ' expenses') + ' selected') : (getFilteredExpenses().length + ' expenses')}}
            </div>
          </div>
          <div class="selection-mode-toggle" *ngIf="isExpensesListExpanded">
            <label class="toggle-switch">
              <input 
                type="checkbox" 
                [checked]="bulkSelectionMode"
                (change)="onSelectionModeToggle($event)">
              <span class="toggle-slider"></span>
              <span class="toggle-label">{{bulkSelectionMode ? 'Selection Mode' : 'Normal Mode'}}</span>
            </label>
          </div>
          <button class="collapse-toggle-btn" type="button" (click)="toggleExpensesListSection()">
            <span class="collapse-icon" [class.rotated]="!isExpensesListExpanded">â–¼</span>
          </button>
        </div>
      </div>
    </div>
    
    <div class="card-body-modern collapsible-content" [class.collapsed]="!isExpensesListExpanded">
      <!-- Skeleton Loading for Expenses List -->
      <div class="expenses-list" *ngIf="isLoading">
        <app-skeleton 
          *ngFor="let item of [1,2,3,4,5]" 
          type="expense-item"
          [lines]="[
            {width: 30, height: 20, marginBottom: 8},
            {width: 60, height: 16, marginBottom: 4},
            {width: 40, height: 14, marginBottom: 0}
          ]">
        </app-skeleton>
      </div>

      <!-- Bulk Actions Bar -->
      <div class="bulk-actions-bar" *ngIf="bulkSelectionMode && isExpensesListExpanded">
        <div class="bulk-actions-left">
          <button class="btn-select-all" (click)="toggleSelectAll()" type="button">
            <span class="btn-icon">{{isAllSelected() ? 'â˜‘ï¸' : 'â˜'}}</span>
            <span class="btn-text">{{isAllSelected() ? 'Deselect All' : 'Select All'}} ({{getTotalFilteredCount()}})</span>
          </button>
          <span class="selection-hint" *ngIf="selectedExpenseIds.size === 0">
            Select expenses to perform bulk actions
          </span>
          <span class="selection-progress" *ngIf="selectedExpenseIds.size > 0 && !isAllSelected()">
            {{selectedExpenseIds.size}} of {{getTotalFilteredCount()}} selected
          </span>
        </div>
        <div class="bulk-actions-right" *ngIf="selectedExpenseIds.size > 0">
          <button 
            class="btn-bulk-action btn-bulk-delete" 
            (click)="bulkDeleteExpenses()" 
            type="button"
            [disabled]="isBulkDeleting">
            <app-loading 
              *ngIf="isBulkDeleting" 
              message="Deleting..." 
              type="button" 
              size="small">
            </app-loading>
            <span *ngIf="!isBulkDeleting" class="btn-content-vertical">
              <span class="btn-icon">ğŸ—‘ï¸</span>
              <span class="btn-text">Delete</span>
              <span class="btn-count">({{selectedExpenseIds.size}})</span>
            </span>
          </button>
        </div>
      </div>

      <div class="expenses-list" *ngIf="!isLoading && getFilteredExpenses().length > 0; else noExpenses">
        <div class="expense-item" 
             *ngFor="let expense of getPaginatedExpenses(); let i = index" 
             [class.selected]="bulkSelectionMode && selectedExpenseIds.has(expense.id)"
             [class.selection-mode]="bulkSelectionMode"
             [class.deleted]="isExpenseDeleted(expense.id)"
             [style.animation-delay]="i * 0.1 + 's'"
             (click)="onExpenseTileClick(expense.id, $event)">
          <!-- Checkbox for bulk selection - only visible in selection mode -->
          <div class="expense-checkbox" *ngIf="bulkSelectionMode && !isExpenseDeleted(expense.id)">
            <input 
              type="checkbox" 
              [checked]="selectedExpenseIds.has(expense.id)"
              (change)="toggleExpenseSelection(expense.id)"
              [id]="'expense-' + expense.id">
            <label [for]="'expense-' + expense.id"></label>
          </div>
          <div class="expense-description">{{expense.description || 'No description'}}</div>
          <div class="expense-date">{{expense.date | date:'MMM dd, yyyy'}}</div>
          <div class="expense-right">
            <div class="expense-amount">{{expense.amount | currency:'INR'}}</div>
            <!-- Undo option when deleted -->
            <div class="expense-undo" *ngIf="isExpenseDeleted(expense.id)">
              <button class="btn-undo-inline" (click)="undoDelete(expense.id)">
                <span class="undo-icon-inline">â†¶</span>
                <span class="undo-text">Undo</span>
              </button>
            </div>
            <!-- Normal actions when not deleted -->
            <div class="expense-actions" [class.hidden]="bulkSelectionMode || isExpenseDeleted(expense.id)">
              <button class="btn-action edit-btn" (click)="editExpense(expense)" title="Edit" [disabled]="isExpenseBeingDeleted(expense.id)">
                <span class="action-icon">âœï¸</span>
              </button>
              <button class="btn-action delete-btn" (click)="deleteExpense(expense)" title="Delete" [disabled]="isExpenseBeingDeleted(expense.id)">
                <app-loading 
                  *ngIf="isExpenseBeingDeleted(expense.id)" 
                  message="Deleting..." 
                  type="button" 
                  size="small">
                </app-loading>
                <span class="action-icon" *ngIf="!isExpenseBeingDeleted(expense.id)">ğŸ—‘ï¸</span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <ng-template #noExpenses>
        <div class="no-expenses">
          <div class="no-expenses-icon">ğŸ“‹</div>
          <h6>No expenses found</h6>
          <p>Add your first expense using the form above!</p>
        </div>
      </ng-template>
      
      <!-- Pagination Controls -->
      <div class="pagination-controls mb-3" *ngIf="getFilteredExpenses().length > itemsPerPage">
        <div class="pagination-layout">
          <div class="pagination-info">
            <span class="text-muted">
              Showing {{getStartIndex() + 1}} to {{getEndIndex()}} of {{getFilteredExpenses().length}} expenses
            </span>
          </div>
          <div class="pagination-navigation">
            <div class="pagination-buttons">
              <button 
                type="button" 
                class="btn btn-outline-secondary btn-sm" 
                [disabled]="currentPage === 1"
                (click)="goToPage(currentPage - 1)"
                title="Previous page">
                â† Previous
              </button>
              <span class="page-info">
                Page {{currentPage}} of {{getTotalPages()}}
              </span>
              <button 
                type="button" 
                class="btn btn-outline-secondary btn-sm" 
                [disabled]="currentPage === getTotalPages()"
                (click)="goToPage(currentPage + 1)"
                title="Next page">
                Next â†’
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div> 