import{a as p,b as x,c as y,d as f,e as I,f as E,g as m,h as v,i as U,j as D,k as j,l as R,m as O}from"./chunk-RELSZ3U4.js";import{Ic as L,M as C,Q as q,R as B,g as w}from"./chunk-4CHXRCSU.js";import{a as u,b as g,c as S,g as d}from"./chunk-RA2WU32H.js";var F=class P{constructor(t){this.authService=t;this.authService.currentUser$.subscribe(e=>{e?this.expensesSubject.value.length>0||this.categoriesSubject.value.length>0?(this.setupRealTimeListeners(),this.loadTrades()):this.loadData():(this.cleanupListeners(),this.expensesSubject.next([]),this.categoriesSubject.next([]),this.tradesSubject.next([]),this.userSettingsSubject.next({}))})}firestore=B(O);expensesSubject=new w([]);categoriesSubject=new w([]);tradesSubject=new w([]);userSettingsSubject=new w({});loadingSubject=new w(!1);expensesUnsubscribe;categoriesUnsubscribe;tradesUnsubscribe;expenses$=this.expensesSubject.asObservable();categories$=this.categoriesSubject.asObservable();trades$=this.tradesSubject.asObservable();userSettings$=this.userSettingsSubject.asObservable();loading$=this.loadingSubject.asObservable();loadData(){return d(this,null,function*(){this.loadingSubject.next(!0);try{yield Promise.all([this.loadExpenses(),this.loadCategories(),this.loadTrades(),this.loadUserSettings()]),this.setupRealTimeListeners()}finally{this.loadingSubject.next(!1)}})}setupRealTimeListeners(){let t=this.authService.getCurrentUserId();if(!t)return;this.cleanupListeners();let e=p(this.firestore,"expenses"),r=y(e,f("userId","==",t),I("date","desc"));this.expensesUnsubscribe=R(r,n=>{let i=[];n.forEach(h=>{i.push(u({id:h.id},h.data()))}),this.expensesSubject.next(i)});let s=p(this.firestore,"categories"),a=y(s,f("userId","==",t));this.categoriesUnsubscribe=R(a,n=>{let i=[];n.forEach(h=>{i.push(u({id:h.id},h.data()))}),this.categoriesSubject.next(i)});let o=p(this.firestore,"trades"),c=y(o,f("userId","==",t));this.tradesUnsubscribe=R(c,n=>{let i=[];n.forEach(h=>{let b=h.data(),l=b.isProfit,T=l!==void 0?typeof l=="boolean"?l:l===!0||l==="true":!0;i.push(g(u({id:h.id},b),{amount:b.amount||0,indexValue:b.indexValue||0,isProfit:T}))}),i.sort((h,b)=>{let l=new Date(h.date).getTime();return new Date(b.date).getTime()-l}),this.tradesSubject.next(i)},n=>{console.error("Error in trades snapshot listener:",n)})}cleanupListeners(){this.expensesUnsubscribe&&(this.expensesUnsubscribe(),this.expensesUnsubscribe=void 0),this.categoriesUnsubscribe&&(this.categoriesUnsubscribe(),this.categoriesUnsubscribe=void 0),this.tradesUnsubscribe&&(this.tradesUnsubscribe(),this.tradesUnsubscribe=void 0)}loadExpenses(){return d(this,null,function*(){try{let t=this.authService.getCurrentUserId();if(!t)return this.expensesSubject.next([]),[];let e=p(this.firestore,"expenses"),r=y(e,f("userId","==",t),I("date","desc")),s=yield m(r),a=[];return s.forEach(o=>{a.push(u({id:o.id},o.data()))}),this.expensesSubject.next(a),a}catch(t){return console.error("Error loading expenses:",t),[]}})}addExpense(t){return d(this,null,function*(){try{let e=this.authService.getCurrentUserId();if(!e)throw new Error("User not authenticated");let r=p(this.firestore,"expenses"),s=g(u({},t),{userId:e,createdAt:new Date().toISOString()});return(yield j(r,s)).id}catch(e){throw console.error("Error adding expense:",e),e}})}updateExpense(t){return d(this,null,function*(){try{let s=this.authService.getCurrentUserId();if(!s)throw new Error("User not authenticated");let a=x(this.firestore,"expenses",t.id);if((yield E(a)).exists()){let r=t,{id:c}=r,n=S(r,["id"]),i=g(u({},n),{userId:s});yield U(a,i)}else{console.warn(`Document with ID ${t.id} does not exist in Firebase. This might be a local-only expense.`);let e=t,{id:c}=e,n=S(e,["id"]),i=g(u({},n),{userId:s});yield v(a,i)}}catch(s){throw console.error("Error updating expense:",s),s}})}deleteExpense(t){return d(this,null,function*(){try{let e=x(this.firestore,"expenses",t);yield D(e)}catch(e){if(console.error("Error deleting expense:",e),e instanceof Error&&e.message&&e.message.includes("does not exist")){console.warn("Document not found - likely a local-only expense");return}throw e}})}migrateLocalExpenses(t){return d(this,null,function*(){try{for(let r of t){if(r.id&&r.id.length>20)continue;let e=r,{id:s}=e,a=S(e,["id"]);yield this.addExpense(a)}}catch(r){throw console.error("Error during migration:",r),r}})}isFirebaseId(t){return!!(t&&t.length>20)}loadCategories(){return d(this,null,function*(){try{let t=this.authService.getCurrentUserId();if(!t)return this.categoriesSubject.next([]),[];let e=p(this.firestore,"categories"),r=y(e,f("userId","==",t)),s=yield m(r),a=[];return s.forEach(o=>{a.push(u({id:o.id},o.data()))}),this.categoriesSubject.next(a),a}catch(t){return console.error("Error loading categories:",t),[]}})}addCategory(t){return d(this,null,function*(){try{let e=this.authService.getCurrentUserId();if(!e)throw new Error("User not authenticated");let r=p(this.firestore,"categories"),s=g(u({},t),{userId:e});return(yield j(r,s)).id}catch(e){throw console.error("Error adding category:",e),e}})}updateCategory(t){return d(this,null,function*(){try{let s=this.authService.getCurrentUserId();if(!s)throw new Error("User not authenticated");let a=x(this.firestore,"categories",t.id);if((yield E(a)).exists()){let r=t,{id:c}=r,n=S(r,["id"]),i=g(u({},n),{userId:s});yield U(a,i)}else{console.warn(`Category with ID ${t.id} does not exist in Firebase. This might be a local-only category.`);let e=t,{id:c}=e,n=S(e,["id"]),i=g(u({},n),{userId:s});yield v(a,i)}}catch(s){throw console.error("Error updating category:",s),s}})}deleteCategory(t){return d(this,null,function*(){try{let e=x(this.firestore,"categories",t);if(!(yield E(e)).exists())return;yield D(e)}catch(e){if(console.error("Error deleting category:",e),e instanceof Error&&e.message.includes("does not exist")){console.warn("Category not found - likely a local-only category");return}throw e}})}loadUserSettings(){return d(this,null,function*(){try{let t=x(this.firestore,"userSettings","default"),e=yield E(t);if(e.exists()){let r=e.data();return this.userSettingsSubject.next(r),r}else{let r={budgetLimit:0,emergencyFund:0,vacationFund:0,theme:"light",currency:"\u20B9"};return yield this.saveUserSettings(r),r}}catch(t){return console.error("Error loading user settings:",t),{budgetLimit:0,emergencyFund:0,vacationFund:0,theme:"light",currency:"\u20B9"}}})}saveUserSettings(t){return d(this,null,function*(){try{let e=x(this.firestore,"userSettings","default");yield v(e,t,{merge:!0}),this.userSettingsSubject.next(t)}catch(e){throw console.error("Error saving user settings:",e),e}})}getExpensesByCategory(t){return d(this,null,function*(){try{let e=this.authService.getCurrentUserId();if(!e)return[];let r=p(this.firestore,"expenses"),s=y(r,f("userId","==",e),f("categoryId","==",t)),a=yield m(s),o=[];return a.forEach(c=>{o.push(u({id:c.id},c.data()))}),o}catch(e){return console.error("Error getting expenses by category:",e),[]}})}getExpensesByDateRange(t,e){return d(this,null,function*(){try{let r=this.authService.getCurrentUserId();if(!r)return[];let s=p(this.firestore,"expenses"),a=y(s,f("userId","==",r),f("date",">=",t),f("date","<=",e),I("date","desc")),o=yield m(a),c=[];return o.forEach(n=>{c.push(u({id:n.id},n.data()))}),c}catch(r){return console.error("Error getting expenses by date range:",r),[]}})}loadTrades(){return d(this,null,function*(){try{let t=this.authService.getCurrentUserId();if(!t)return this.tradesSubject.next([]),[];this.tradesUnsubscribe||this.setupRealTimeListeners();let e=p(this.firestore,"trades"),r=y(e,f("userId","==",t)),s=yield m(r),a=[];return s.forEach(o=>{let c=o.data(),n=c.isProfit,i=n!==void 0?typeof n=="boolean"?n:n===!0||n==="true":!0;a.push(g(u({id:o.id},c),{isProfit:i}))}),a.sort((o,c)=>{let n=new Date(o.date).getTime();return new Date(c.date).getTime()-n}),this.tradesSubject.next(a),a}catch(t){return console.error("Error loading trades:",t),[]}})}addTrade(t){return d(this,null,function*(){try{let e=this.authService.getCurrentUserId();if(!e)throw new Error("User not authenticated");let r=p(this.firestore,"trades"),s=g(u({},t),{userId:e,createdAt:new Date().toISOString()});return(yield j(r,s)).id}catch(e){throw console.error("Error adding trade:",e),e}})}updateTrade(t){return d(this,null,function*(){try{let s=this.authService.getCurrentUserId();if(!s)throw new Error("User not authenticated");let a=x(this.firestore,"trades",t.id);if((yield E(a)).exists()){let r=t,{id:c}=r,n=S(r,["id"]),i=g(u({},n),{userId:s});yield U(a,i)}else{let e=t,{id:c}=e,n=S(e,["id"]),i=g(u({},n),{userId:s});yield v(a,i)}}catch(s){throw console.error("Error updating trade:",s),s}})}deleteTrade(t){return d(this,null,function*(){try{let e=x(this.firestore,"trades",t);yield D(e)}catch(e){throw console.error("Error deleting trade:",e),e}})}getTradesByDateRange(t,e){return d(this,null,function*(){try{let r=this.authService.getCurrentUserId();if(!r)return[];let s=p(this.firestore,"trades"),a=y(s,f("userId","==",r)),o=yield m(a),c=[];return o.forEach(n=>{let i=n.data(),h=i.isProfit,b=h!==void 0?typeof h=="boolean"?h:h===!0||h==="true":!0,l=g(u({id:n.id},i),{isProfit:b});l.date>=t&&l.date<=e&&c.push(l)}),c.sort((n,i)=>{let h=new Date(n.date).getTime();return new Date(i.date).getTime()-h}),c}catch(r){return console.error("Error getting trades by date range:",r),[]}})}static \u0275fac=function(e){return new(e||P)(q(L))};static \u0275prov=C({token:P,factory:P.\u0275fac,providedIn:"root"})};export{F as a};
