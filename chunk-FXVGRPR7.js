import{a as g,b as x,c as y,d as p,e as I,f as E,g as w,h as v,i as U,j as D,k as C,l as R,m as A}from"./chunk-2USY7SJO.js";import{Hc as B,M as T,Q as $,R as q,g as S}from"./chunk-TTIH5BEO.js";import{a as h,b as l,c as m,g as u}from"./chunk-RA2WU32H.js";var F=class j{constructor(t){this.authService=t;this.authService.currentUser$.subscribe(e=>{e?this.expensesSubject.value.length>0||this.categoriesSubject.value.length>0?(this.setupRealTimeListeners(),this.loadTrades()):this.loadData():(this.cleanupListeners(),this.expensesSubject.next([]),this.categoriesSubject.next([]),this.tradesSubject.next([]),this.userSettingsSubject.next({}))})}firestore=q(A);expensesSubject=new S([]);categoriesSubject=new S([]);tradesSubject=new S([]);userSettingsSubject=new S({});loadingSubject=new S(!1);expensesUnsubscribe;categoriesUnsubscribe;tradesUnsubscribe;expenses$=this.expensesSubject.asObservable();categories$=this.categoriesSubject.asObservable();trades$=this.tradesSubject.asObservable();userSettings$=this.userSettingsSubject.asObservable();loading$=this.loadingSubject.asObservable();loadData(){return u(this,null,function*(){this.loadingSubject.next(!0);try{yield Promise.all([this.loadExpenses(),this.loadCategories(),this.loadTrades(),this.loadUserSettings()]),this.setupRealTimeListeners()}finally{this.loadingSubject.next(!1)}})}setupRealTimeListeners(){let t=this.authService.getCurrentUserId();if(!t)return;this.cleanupListeners();let e=g(this.firestore,"expenses"),s=y(e,p("userId","==",t),I("date","desc"));this.expensesUnsubscribe=R(s,n=>{let i=[];n.forEach(d=>{i.push(h({id:d.id},d.data()))}),this.expensesSubject.next(i),console.log(`Real-time update: ${i.length} expenses`)});let r=g(this.firestore,"categories"),o=y(r,p("userId","==",t));this.categoriesUnsubscribe=R(o,n=>{let i=[];n.forEach(d=>{i.push(h({id:d.id},d.data()))}),this.categoriesSubject.next(i),console.log(`Real-time update: ${i.length} categories`)});let a=g(this.firestore,"trades"),c=y(a,p("userId","==",t));this.tradesUnsubscribe=R(c,n=>{let i=[];n.forEach(d=>{let b=d.data(),f=b.isProfit,P=f!==void 0?typeof f=="boolean"?f:f===!0||f==="true":!0;i.push(l(h({id:d.id},b),{amount:b.amount||0,indexValue:b.indexValue||0,isProfit:P}))}),i.sort((d,b)=>{let f=new Date(d.date).getTime();return new Date(b.date).getTime()-f}),console.log(`Real-time update: ${i.length} trades`,i.map(d=>({symbol:d.symbol,amount:d.amount,isProfit:d.isProfit}))),this.tradesSubject.next(i)},n=>{console.error("Error in trades snapshot listener:",n)})}cleanupListeners(){this.expensesUnsubscribe&&(this.expensesUnsubscribe(),this.expensesUnsubscribe=void 0),this.categoriesUnsubscribe&&(this.categoriesUnsubscribe(),this.categoriesUnsubscribe=void 0),this.tradesUnsubscribe&&(this.tradesUnsubscribe(),this.tradesUnsubscribe=void 0)}loadExpenses(){return u(this,null,function*(){try{let t=this.authService.getCurrentUserId();if(!t)return this.expensesSubject.next([]),[];let e=g(this.firestore,"expenses"),s=y(e,p("userId","==",t),I("date","desc")),r=yield w(s),o=[];return r.forEach(a=>{o.push(h({id:a.id},a.data()))}),this.expensesSubject.next(o),o}catch(t){return console.error("Error loading expenses:",t),[]}})}addExpense(t){return u(this,null,function*(){try{let e=this.authService.getCurrentUserId();if(!e)throw new Error("User not authenticated");let s=g(this.firestore,"expenses"),r=l(h({},t),{userId:e,createdAt:new Date().toISOString()});return(yield C(s,r)).id}catch(e){throw console.error("Error adding expense:",e),e}})}updateExpense(t){return u(this,null,function*(){try{let r=this.authService.getCurrentUserId();if(!r)throw new Error("User not authenticated");console.log(`Attempting to update expense with ID: ${t.id}`);let o=x(this.firestore,"expenses",t.id);if((yield E(o)).exists()){let s=t,{id:c}=s,n=m(s,["id"]),i=l(h({},n),{userId:r});yield U(o,i),console.log(`Expense ${t.id} updated successfully`)}else{console.warn(`Document with ID ${t.id} does not exist in Firebase. This might be a local-only expense.`);let e=t,{id:c}=e,n=m(e,["id"]),i=l(h({},n),{userId:r});yield v(o,i),console.log(`Created new expense with ID: ${t.id}`)}}catch(r){throw console.error("Error updating expense:",r),r}})}deleteExpense(t){return u(this,null,function*(){try{console.log(`Attempting to delete expense with ID: ${t}`);let e=x(this.firestore,"expenses",t);yield D(e),console.log(`Expense ${t} deleted successfully`)}catch(e){if(console.error("Error deleting expense:",e),e instanceof Error&&e.message&&e.message.includes("does not exist")){console.warn("Document not found - likely a local-only expense");return}throw e}})}migrateLocalExpenses(t){return u(this,null,function*(){try{console.log("Starting migration of local expenses to Firebase...");for(let s of t){if(s.id&&s.id.length>20){console.log(`Expense ${s.id} already migrated, skipping...`);continue}let e=s,{id:r}=e,o=m(e,["id"]),a=yield this.addExpense(o);console.log(`Migrated expense from local ID ${r} to Firebase ID ${a}`)}console.log("Migration completed successfully")}catch(s){throw console.error("Error during migration:",s),s}})}isFirebaseId(t){return!!(t&&t.length>20)}loadCategories(){return u(this,null,function*(){try{let t=this.authService.getCurrentUserId();if(!t)return console.log("No user authenticated, returning empty categories"),this.categoriesSubject.next([]),[];let e=g(this.firestore,"categories"),s=y(e,p("userId","==",t)),r=yield w(s),o=[];return r.forEach(a=>{o.push(h({id:a.id},a.data()))}),this.categoriesSubject.next(o),o}catch(t){return console.error("Error loading categories:",t),[]}})}addCategory(t){return u(this,null,function*(){try{let e=this.authService.getCurrentUserId();if(!e)throw new Error("User not authenticated");let s=g(this.firestore,"categories"),r=l(h({},t),{userId:e});return(yield C(s,r)).id}catch(e){throw console.error("Error adding category:",e),e}})}updateCategory(t){return u(this,null,function*(){try{let r=this.authService.getCurrentUserId();if(!r)throw new Error("User not authenticated");console.log(`Attempting to update category with ID: ${t.id}`);let o=x(this.firestore,"categories",t.id);if((yield E(o)).exists()){let s=t,{id:c}=s,n=m(s,["id"]),i=l(h({},n),{userId:r});yield U(o,i),console.log(`Category ${t.id} updated successfully`)}else{console.warn(`Category with ID ${t.id} does not exist in Firebase. This might be a local-only category.`);let e=t,{id:c}=e,n=m(e,["id"]),i=l(h({},n),{userId:r});yield v(o,i),console.log(`Created new category with ID: ${t.id}`)}}catch(r){throw console.error("Error updating category:",r),r}})}deleteCategory(t){return u(this,null,function*(){try{console.log(`Attempting to delete category with ID: ${t} (length: ${t.length})`);let e=x(this.firestore,"categories",t),s=yield E(e);if(console.log(`Document exists: ${s.exists()}`),!s.exists()){console.warn(`Category with ID ${t} does not exist in Firebase. This might be a local-only category.`);return}console.log("Document found, proceeding with deletion..."),yield D(e),console.log(`Category ${t} deleted successfully`)}catch(e){if(console.error("Error deleting category:",e),e instanceof Error&&e.message.includes("does not exist")){console.warn("Category not found - likely a local-only category");return}throw e}})}loadUserSettings(){return u(this,null,function*(){try{let t=x(this.firestore,"userSettings","default"),e=yield E(t);if(e.exists()){let s=e.data();return this.userSettingsSubject.next(s),s}else{let s={budgetLimit:0,emergencyFund:0,vacationFund:0,theme:"light",currency:"\u20B9"};return yield this.saveUserSettings(s),s}}catch(t){return console.error("Error loading user settings:",t),{budgetLimit:0,emergencyFund:0,vacationFund:0,theme:"light",currency:"\u20B9"}}})}saveUserSettings(t){return u(this,null,function*(){try{let e=x(this.firestore,"userSettings","default");yield v(e,t,{merge:!0}),this.userSettingsSubject.next(t)}catch(e){throw console.error("Error saving user settings:",e),e}})}getExpensesByCategory(t){return u(this,null,function*(){try{let e=this.authService.getCurrentUserId();if(!e)return[];let s=g(this.firestore,"expenses"),r=y(s,p("userId","==",e),p("categoryId","==",t)),o=yield w(r),a=[];return o.forEach(c=>{a.push(h({id:c.id},c.data()))}),a}catch(e){return console.error("Error getting expenses by category:",e),[]}})}getExpensesByDateRange(t,e){return u(this,null,function*(){try{let s=this.authService.getCurrentUserId();if(!s)return[];let r=g(this.firestore,"expenses"),o=y(r,p("userId","==",s),p("date",">=",t),p("date","<=",e),I("date","desc")),a=yield w(o),c=[];return a.forEach(n=>{c.push(h({id:n.id},n.data()))}),c}catch(s){return console.error("Error getting expenses by date range:",s),[]}})}loadTrades(){return u(this,null,function*(){try{let t=this.authService.getCurrentUserId();if(!t)return this.tradesSubject.next([]),[];this.tradesUnsubscribe||this.setupRealTimeListeners();let e=g(this.firestore,"trades"),s=y(e,p("userId","==",t)),r=yield w(s),o=[];return r.forEach(a=>{let c=a.data(),n=c.isProfit,i=n!==void 0?typeof n=="boolean"?n:n===!0||n==="true":!0;o.push(l(h({id:a.id},c),{isProfit:i}))}),o.sort((a,c)=>{let n=new Date(a.date).getTime();return new Date(c.date).getTime()-n}),this.tradesSubject.next(o),console.log(`Loaded ${o.length} trades`),o}catch(t){return console.error("Error loading trades:",t),[]}})}addTrade(t){return u(this,null,function*(){try{let e=this.authService.getCurrentUserId();if(!e)throw new Error("User not authenticated");let s=g(this.firestore,"trades"),r=l(h({},t),{userId:e,createdAt:new Date().toISOString()});return(yield C(s,r)).id}catch(e){throw console.error("Error adding trade:",e),e}})}updateTrade(t){return u(this,null,function*(){try{let r=this.authService.getCurrentUserId();if(!r)throw new Error("User not authenticated");let o=x(this.firestore,"trades",t.id);if((yield E(o)).exists()){let s=t,{id:c}=s,n=m(s,["id"]),i=l(h({},n),{userId:r});yield U(o,i)}else{let e=t,{id:c}=e,n=m(e,["id"]),i=l(h({},n),{userId:r});yield v(o,i)}}catch(r){throw console.error("Error updating trade:",r),r}})}deleteTrade(t){return u(this,null,function*(){try{let e=x(this.firestore,"trades",t);yield D(e)}catch(e){throw console.error("Error deleting trade:",e),e}})}getTradesByDateRange(t,e){return u(this,null,function*(){try{let s=this.authService.getCurrentUserId();if(!s)return[];let r=g(this.firestore,"trades"),o=y(r,p("userId","==",s)),a=yield w(o),c=[];return a.forEach(n=>{let i=n.data(),d=i.isProfit,b=d!==void 0?typeof d=="boolean"?d:d===!0||d==="true":!0,f=l(h({id:n.id},i),{isProfit:b});f.date>=t&&f.date<=e&&c.push(f)}),c.sort((n,i)=>{let d=new Date(n.date).getTime();return new Date(i.date).getTime()-d}),c}catch(s){return console.error("Error getting trades by date range:",s),[]}})}static \u0275fac=function(e){return new(e||j)($(B))};static \u0275prov=T({token:j,factory:j.\u0275fac,providedIn:"root"})};export{F as a};
